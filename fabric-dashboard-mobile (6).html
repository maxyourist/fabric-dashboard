<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d1f3c">
<title>SWAT Lookup</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --denim:    #1a3a5c;
  --denim-lt: #2a5298;
  --denim-dk: #0d1f3c;
  --indigo:   #3d6eb4;
  --fade:     #4a7fc1;
  --white:    #e8f0fe;
  --gold:     #f0b429;
  --teal:     #14b8a6;
  --cyan:     #38bdf8;
  --green:    #34d399;
  --red:      #f87171;
  --text:     #dce8f8;
  --text2:    #8aacce;
  --muted:    #3d5a7a;
  --border:   rgba(58,110,180,0.25);
  --sat: env(safe-area-inset-top,0px);
  --sab: env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Space Grotesk',sans-serif;background:var(--denim-dk);color:var(--text);-webkit-font-smoothing:antialiased;}

body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:
    repeating-linear-gradient(90deg,transparent,transparent 3px,rgba(255,255,255,.012) 3px,rgba(255,255,255,.012) 4px),
    repeating-linear-gradient(180deg,transparent,transparent 3px,rgba(255,255,255,.008) 3px,rgba(255,255,255,.008) 4px),
    repeating-linear-gradient(45deg,transparent,transparent 8px,rgba(255,255,255,.006) 8px,rgba(255,255,255,.006) 9px);
}

/* LOADER */
#loadScreen{
  position:fixed;inset:0;z-index:1000;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:var(--denim-dk);
  transition:opacity .5s ease,transform .5s ease;
}
#loadScreen.hiding{opacity:0;transform:translateY(-20px);pointer-events:none;}

.weave-grid{
  width:120px;height:120px;border-radius:16px;overflow:hidden;
  box-shadow:0 0 40px rgba(61,110,180,.4),0 0 80px rgba(61,110,180,.15);
  position:relative;margin-bottom:28px;
}
.weave-row{display:flex;height:12px;}
.weave-thread{flex:1;height:100%;}
.weave-thread.odd{background:rgba(42,82,152,.9);}
.weave-thread.even{background:rgba(26,58,92,.95);}

@keyframes weaveIn{0%,100%{opacity:.3;transform:scaleY(.6)}50%{opacity:1;transform:scaleY(1)}}
@keyframes threadPull{0%{top:-4px;opacity:0}20%{opacity:1}80%{opacity:1}100%{top:110px;opacity:0}}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}
@keyframes stitchRun{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes cardIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:none}}

.thread-pull{
  position:absolute;top:-4px;left:50%;transform:translateX(-50%);
  width:3px;height:30px;
  background:linear-gradient(180deg,transparent,var(--cyan),transparent);
  animation:threadPull 1.8s ease-in-out infinite;border-radius:2px;
}
.load-title{font-size:22px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--white);margin-bottom:6px;}
.load-sub{font-size:13px;color:var(--text2);font-family:'JetBrains Mono',monospace;letter-spacing:.05em;animation:pulse 2s ease-in-out infinite;}
.load-stitch{
  width:200px;height:2px;margin-top:18px;
  background:repeating-linear-gradient(90deg,var(--indigo) 0,var(--indigo) 6px,transparent 6px,transparent 10px);
  position:relative;overflow:hidden;
}
.load-stitch::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,var(--cyan),transparent);animation:stitchRun 1.5s ease-in-out infinite;}

/* APP */
.app{position:relative;z-index:1;display:flex;flex-direction:column;height:100%;height:100dvh;}

/* HEADER */
header{
  flex-shrink:0;padding:calc(var(--sat) + 14px) 18px 14px;
  background:rgba(13,31,60,.97);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);position:relative;
}
header::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:repeating-linear-gradient(90deg,var(--indigo) 0,var(--indigo) 8px,transparent 8px,transparent 14px);
  opacity:.35;
}
.hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.hdr-brand{display:flex;align-items:center;gap:10px;}
.hdr-patch{
  width:36px;height:36px;border-radius:8px;
  background:linear-gradient(135deg,var(--denim-lt),var(--indigo));
  border:2px solid rgba(255,255,255,.15);
  display:flex;align-items:center;justify-content:center;font-size:18px;
  box-shadow:0 2px 12px rgba(61,110,180,.4);
}
.hdr-text h1{font-size:17px;font-weight:700;color:var(--white);letter-spacing:.02em;}
.hdr-text p{font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;letter-spacing:.1em;text-transform:uppercase;}
.live-pill{
  display:flex;align-items:center;gap:6px;padding:5px 10px;border-radius:100px;
  background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.25);
  font-size:11px;font-weight:600;color:var(--green);font-family:'JetBrains Mono',monospace;
}
.live-pill.loading{background:rgba(240,180,41,.1);border-color:rgba(240,180,41,.25);color:var(--gold);}
.live-pill.error{background:rgba(248,113,113,.1);border-color:rgba(248,113,113,.25);color:var(--red);}
.live-dot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:blink 2s infinite;}
.live-pill.error .live-dot{animation:none;}

/* SEARCH */
.search-wrap{position:relative;}
.search-inp{
  width:100%;padding:14px 50px 14px 18px;border-radius:12px;
  background:rgba(26,58,92,.6);border:1.5px solid var(--border);
  color:var(--white);font-family:'Space Grotesk',sans-serif;font-size:17px;font-weight:500;
  outline:none;-webkit-appearance:none;letter-spacing:.02em;
  transition:border-color .2s,box-shadow .2s,background .2s;
}
.search-inp::placeholder{color:var(--muted);font-weight:400;}
.search-inp:focus{border-color:var(--indigo);background:rgba(26,58,92,.9);box-shadow:0 0 0 3px rgba(61,110,180,.2);}
.search-x{
  position:absolute;right:14px;top:50%;transform:translateY(-50%);
  width:28px;height:28px;border-radius:50%;
  background:rgba(61,110,180,.2);border:1px solid var(--border);
  color:var(--text2);font-size:13px;cursor:pointer;
  display:none;align-items:center;justify-content:center;
}
.search-x.show{display:flex;}

/* SCROLL */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 18px calc(32px + var(--sab));}

/* EMPTY */
.empty-state{display:flex;flex-direction:column;align-items:center;padding:52px 24px;gap:10px;text-align:center;}
.empty-icon{font-size:52px;margin-bottom:8px;opacity:.5;}
.empty-title{font-size:18px;font-weight:700;color:var(--text2);}
.empty-sub{font-size:13px;color:var(--muted);line-height:1.6;max-width:260px;}

/* RESULT CARD */
.result-card{
  background:linear-gradient(160deg,rgba(26,58,92,.95),rgba(13,31,60,.98));
  border:1px solid rgba(61,110,180,.4);border-radius:20px;overflow:hidden;
  margin-bottom:16px;
  box-shadow:0 8px 32px rgba(0,0,0,.4),0 0 0 1px rgba(255,255,255,.04);
  animation:cardIn .3s cubic-bezier(.34,1.56,.64,1);
}
.card-flap{
  background:linear-gradient(180deg,rgba(42,82,152,.6),rgba(26,58,92,.4));
  border-bottom:1px solid var(--border);padding:16px 18px;
  position:relative;overflow:hidden;
}
.card-flap::before{
  content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(135deg,transparent,transparent 4px,rgba(255,255,255,.015) 4px,rgba(255,255,255,.015) 5px);
}
.card-flap::after{
  content:'';position:absolute;bottom:0;left:16px;right:16px;height:1px;
  background:repeating-linear-gradient(90deg,var(--indigo) 0,var(--indigo) 5px,transparent 5px,transparent 9px);
  opacity:.5;
}
.flap-top{display:flex;align-items:flex-start;justify-content:space-between;position:relative;}
.swat-code{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:var(--white);letter-spacing:.04em;text-shadow:0 0 20px rgba(56,189,248,.3);}
.swat-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.12em;color:var(--text2);margin-top:4px;}
.uses-badge{background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.3);border-radius:10px;padding:8px 14px;text-align:center;flex-shrink:0;}
.uses-num{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;color:var(--cyan);line-height:1;}
.uses-lbl{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--text2);margin-top:2px;}

/* STAT ROWS */
.stat-row{display:flex;align-items:center;padding:15px 18px;border-bottom:1px solid rgba(61,110,180,.12);gap:14px;position:relative;}
.stat-row:last-child{border-bottom:none;}
.stat-rank{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace;flex-shrink:0;}
.rank-1{background:rgba(240,180,41,.15);border:1.5px solid rgba(240,180,41,.4);color:var(--gold);}
.rank-2{background:rgba(56,189,248,.12);border:1.5px solid rgba(56,189,248,.3);color:var(--cyan);}
.rank-3{background:rgba(52,211,153,.1);border:1.5px solid rgba(52,211,153,.25);color:var(--green);}
.stat-icon{font-size:20px;flex-shrink:0;}
.stat-body{flex:1;min-width:0;}
.stat-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--text2);margin-bottom:4px;}
.stat-value{font-size:20px;font-weight:700;color:var(--white);font-family:'JetBrains Mono',monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.stat-value.factory{color:var(--gold);font-size:18px;}
.stat-value.po{color:var(--cyan);}
.stat-value.usage{color:var(--green);font-size:16px;}
.stat-value.none{color:var(--muted);font-size:15px;font-family:'Space Grotesk',sans-serif;font-weight:400;}
.stat-sub{font-size:11px;color:var(--text2);margin-top:3px;font-family:'JetBrains Mono',monospace;}
.stitch-div{height:1px;margin:0 18px;background:repeating-linear-gradient(90deg,var(--muted) 0,var(--muted) 4px,transparent 4px,transparent 8px);opacity:.2;}

/* STYLES */
.styles-section{padding:14px 18px 18px;border-top:1px solid rgba(61,110,180,.12);}
.styles-lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--text2);margin-bottom:10px;}
.style-tags{display:flex;flex-wrap:wrap;gap:6px;}
.style-tag{font-size:12px;color:var(--fade);background:rgba(61,110,180,.12);border:1px solid rgba(61,110,180,.22);padding:4px 10px;border-radius:100px;font-family:'JetBrains Mono',monospace;}

/* LIST */
.list-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.list-hdr-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--text2);}
.list-hdr-count{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;}
.ulist{display:flex;flex-direction:column;gap:6px;}
.uitem{display:flex;align-items:center;gap:12px;padding:13px 16px;background:rgba(26,58,92,.4);border:1px solid rgba(61,110,180,.15);border-radius:13px;transition:all .15s;cursor:pointer;}
.uitem:active{background:rgba(42,82,152,.3);border-color:var(--indigo);transform:scale(.99);}
.u-rank{font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace;width:22px;text-align:right;flex-shrink:0;}
.u-info{flex:1;min-width:0;}
.u-name{font-size:15px;font-weight:700;color:var(--white);font-family:'JetBrains Mono',monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.u-po{font-size:11px;color:var(--teal);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.u-right{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.u-bar{height:3px;border-radius:2px;background:linear-gradient(90deg,var(--denim-lt),var(--cyan));}
.u-ct{font-size:14px;font-weight:700;color:var(--cyan);font-family:'JetBrains Mono',monospace;min-width:30px;text-align:right;}

/* ERROR */
.err-box{background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.25);border-radius:14px;padding:24px;text-align:center;color:var(--red);font-size:14px;line-height:1.7;}
.retry-btn{margin-top:12px;padding:10px 24px;border-radius:10px;border:none;background:var(--indigo);color:#fff;font-size:14px;font-weight:600;cursor:pointer;font-family:'Space Grotesk',sans-serif;}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loadScreen">
  <div style="position:relative;margin-bottom:28px;">
    <div class="weave-grid" id="weaveGrid"></div>
    <div class="thread-pull"></div>
  </div>
  <div class="load-title">SWAT Lookup</div>
  <div class="load-sub" id="loadMsg">weaving data threads...</div>
  <div class="load-stitch"></div>
</div>

<!-- APP -->
<div class="app">
  <header>
    <div class="hdr-top">
      <div class="hdr-brand">
        <div class="hdr-patch">üßµ</div>
        <div class="hdr-text">
          <h1>SWAT Lookup</h1>
          <p>Fabric Intelligence</p>
        </div>
      </div>
      <div class="live-pill loading" id="livePill">
        <div class="live-dot"></div>
        <span id="liveText">loading</span>
      </div>
    </div>
    <div class="search-wrap">
      <input class="search-inp" id="searchInp" type="text"
        placeholder="Enter SWAT or fabric code..."
        oninput="onSearch()" autocomplete="off" autocorrect="off"
        autocapitalize="characters" spellcheck="false">
      <button class="search-x" id="searchX" onclick="clearSearch()">‚úï</button>
    </div>
  </header>
  <div class="scroll" id="scrollArea"></div>
</div>

<script>
const WORKER_URL='https://icy-king-649a.myourist.workers.dev';
let fabMap={},poMap={},metaMap={},swatMap={},factoryMap={};

// BUILD WEAVE
(function(){
  const g=document.getElementById('weaveGrid');
  for(let r=0;r<10;r++){
    const row=document.createElement('div');
    row.className='weave-row';
    for(let c=0;c<8;c++){
      const t=document.createElement('div');
      t.className='weave-thread '+(c%2===0?'odd':'even');
      t.style.animationName='weaveIn';
      t.style.animationDuration='1.8s';
      t.style.animationTimingFunction='ease-in-out';
      t.style.animationIterationCount='infinite';
      t.style.animationDelay=(r*8+c)*0.04+'s';
      row.appendChild(t);
    }
    g.appendChild(row);
  }
})();

// LOAD
async function loadData(){
  setStatus('loading','loading');
  msg('weaving data threads...');
  try {
    const res=await Promise.race([
      fetch(WORKER_URL,{mode:'cors'}),
      new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),60000))
    ]);
    msg('pulling fabric codes...');
    const j=await res.json();
    if(!j||!j.data)throw new Error('No data');
    msg('stitching records...');
    await sleep(400);
    buildMaps(j.data);
    msg('ready ‚úì');
    await sleep(500);
    hideLoader();
    setStatus('live','live');
    renderDefault();
  } catch(e){
    msg('failed to load');
    setStatus('error','error');
    document.getElementById('scrollArea').innerHTML=`<div class="err-box">‚ùå Could not load data<br><small>${esc(e.message)}</small><br><button class="retry-btn" onclick="location.reload()">Retry</button></div>`;
    hideLoader();
  }
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function msg(m){document.getElementById('loadMsg').textContent=m;}
function hideLoader(){const s=document.getElementById('loadScreen');s.classList.add('hiding');setTimeout(()=>s.style.display='none',600);}
function setStatus(state,text){
  const p=document.getElementById('livePill');
  p.className='live-pill'+(state==='live'?'':' '+state);
  document.getElementById('liveText').textContent=text;
}

// MAPS
function buildMaps(data){
  swatMap={};
  const fc=data['FABRIC CODES'];
  if(fc){fc.forEach(row=>{const f=String(row[0]||'').trim();if(!f)return;for(let i=1;i<=4;i++){const s=String(row[i]||'').trim().toUpperCase();if(s){swatMap[s]=f;const fcu=f.toUpperCase();if(!factoryMap[fcu])factoryMap[fcu]=[];factoryMap[fcu].push(s);}}});}

  const dRx=/\d+\/\d+/;
  const sheets=Object.keys(data).filter(n=>dRx.test(n));
  const allRows=sheets.flatMap(n=>parseSheet(data[n],n));

  fabMap={}; metaMap={};
  const poEntries={};
  allRows.forEach(r=>{
    const nf=norm(r.fabric);
    if(!nf)return;
    fabMap[nf]=(fabMap[nf]||0)+1;
    if(!metaMap[nf])metaMap[nf]={weeks:new Set(),styles:new Set(),first:r.sheet,last:r.sheet};
    const m=metaMap[nf];
    m.weeks.add(r.sheet);
    if(r.style)m.styles.add(r.style);
    if(sdv(r.sheet)<sdv(m.first))m.first=r.sheet;
    if(sdv(r.sheet)>sdv(m.last))m.last=r.sheet;
    const rawPO=r.fab_po?r.fab_po.replace(/^po[^\d]*/i,'').trim():'';
    if(rawPO&&/^\d+$/.test(rawPO)){
      if(!poEntries[nf])poEntries[nf]=[];
      poEntries[nf].push({po:rawPO,sheet:r.sheet,dv:sdv(r.sheet)});
    }
  });
  Object.entries(poEntries).forEach(([nf,e])=>{e.sort((a,b)=>b.dv-a.dv);poMap[nf]={po:e[0].po,sheet:e[0].sheet};});
}

function parseSheet(grid,name){
  if(!grid||grid.length<2)return[];
  let hi=0;
  for(let i=0;i<Math.min(6,grid.length);i++){if(grid[i].map(c=>String(c).toLowerCase()).includes('style')){hi=i;break;}}
  const hd=grid[hi].map(c=>String(c).toLowerCase().trim());
  const col=(row,n)=>{const i=hd.indexOf(n);return i>=0?String(row[i]??'').trim():'';};
  return grid.slice(hi+1).filter(r=>col(r,'style')).map(r=>({sheet:name,style:col(r,'style'),fabric:col(r,'fab'),fab_po:col(r,'fab po')||col(r,'fab_po')}));
}

function sdv(name){
  if(!name)return 0;
  const ym=name.match(/\b(20\d{2})\b/);const y=ym?parseInt(ym[1]):0;
  const parts=name.split(/\s*-\s*/);let mo=0,d=0;
  for(let i=parts.length-1;i>=0;i--){const dm=parts[i].match(/(\d{1,2})\/(\d{1,2})/);if(dm){mo=parseInt(dm[1]);d=parseInt(dm[2]);break;}}
  return y*10000+mo*100+d;
}

function norm(s){return String(s||'').trim().toUpperCase();}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// SEARCH
function onSearch(){
  const q=document.getElementById('searchInp').value.trim();
  document.getElementById('searchX').classList.toggle('show',q.length>0);
  q.length===0?renderDefault():renderSearch(q.toUpperCase());
}
function clearSearch(){
  document.getElementById('searchInp').value='';
  document.getElementById('searchX').classList.remove('show');
  renderDefault();
}
function selectFab(name){
  document.getElementById('searchInp').value=name;
  document.getElementById('searchX').classList.add('show');
  renderSearch(name);
  document.getElementById('scrollArea').scrollTop=0;
}

// DEFAULT
function renderDefault(){
  const entries=Object.entries(fabMap).sort((a,b)=>b[1]-a[1]);
  const max=entries[0]?.[1]||1;
  const el=document.getElementById('scrollArea');
  if(!entries.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">üßµ</div><div class="empty-title">No data</div></div>`;return;}
  el.innerHTML=`
    <div class="list-hdr">
      <div class="list-hdr-title">All Fabrics by Usage</div>
      <div class="list-hdr-count">${entries.length} codes</div>
    </div>
    <div class="ulist">${entries.map(([name,ct],i)=>{
      const bw=Math.round(ct/max*70);
      const po=poMap[name]?.po||'';
      return`<div class="uitem" onclick="selectFab('${esc(name)}')">
        <span class="u-rank">${i+1}</span>
        <div class="u-info"><div class="u-name">${esc(name)}</div>${po?`<div class="u-po">PO: ${esc(po)}</div>`:''}</div>
        <div class="u-right"><div class="u-bar" style="width:${bw}px;max-width:70px"></div><div class="u-ct">${ct}√ó</div></div>
      </div>`;
    }).join('')}</div>`;
}

// RESULT
function renderSearch(q){
  const el=document.getElementById('scrollArea');
  const fabKey=Object.keys(fabMap).find(k=>k===q)||Object.keys(fabMap).find(k=>k.includes(q))||'';
  // Bidirectional: SWAT->factory or factory->SWAT codes
  const bySwat = swatMap[q] || Object.entries(swatMap).find(([k])=>k.includes(q))?.[1] || '';
  const byFactory = factoryMap[q] || Object.entries(factoryMap).find(([k])=>k.includes(q))?.[1];
  const factory = bySwat || (byFactory ? byFactory.join(', ') : '');
  const factoryLabel = bySwat ? 'Factory code' : byFactory ? 'SWAT codes' : 'Factory Code';
  if(!fabKey&&!factory){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">No results for "${esc(q)}"</div><div class="empty-sub">Try a SWAT code like A503 or a fabric code like W652</div></div>`;
    return;
  }
  const uses=fabKey?fabMap[fabKey]:0;
  const meta=fabKey?metaMap[fabKey]:{};
  const lpo=fabKey?poMap[fabKey]:null;
  const styles=meta.styles?[...meta.styles]:[];
  const lastFmt=meta.last||'‚Äî';
  const firstFmt=meta.first||'‚Äî';

  el.innerHTML=`
    <div class="result-card">
      <div class="card-flap">
        <div class="flap-top">
          <div>
            <div class="swat-code">${esc(fabKey||q)}</div>
            <div class="swat-label">SWAT / Fabric Code</div>
          </div>
          <div class="uses-badge">
            <div class="uses-num">${uses}</div>
            <div class="uses-lbl">times used</div>
          </div>
        </div>
      </div>
      <div>
        <div class="stat-row">
          <div class="stat-rank rank-1">1</div>
          <div class="stat-icon">üè≠</div>
          <div class="stat-body">
            <div class="stat-label">${factoryLabel}</div>
            <div class="stat-value factory">${factory?esc(factory):'<span class="none">Not mapped</span>'}</div>
            ${factory?`<div class="stat-sub">from FABRIC CODES tab</div>`:''}
          </div>
        </div>
        <div class="stitch-div"></div>
        <div class="stat-row">
          <div class="stat-rank rank-2">2</div>
          <div class="stat-icon">üìã</div>
          <div class="stat-body">
            <div class="stat-label">Last PO Number</div>
            <div class="stat-value po">${lpo?esc(lpo.po):'<span class="none">No PO on record</span>'}</div>
            ${lpo?`<div class="stat-sub">week of ${esc(lpo.sheet)}</div>`:''}
          </div>
        </div>
        <div class="stitch-div"></div>
        <div class="stat-row">
          <div class="stat-rank rank-3">3</div>
          <div class="stat-icon">üìÖ</div>
          <div class="stat-body">
            <div class="stat-label">Usage &amp; Timeline</div>
            <div class="stat-value usage">${uses}√ó ¬∑ last ${esc(lastFmt)}</div>
            <div class="stat-sub">first used ${esc(firstFmt)}</div>
          </div>
        </div>
      </div>
      ${styles.length?`<div class="styles-section">
        <div class="styles-lbl">Associated Styles (${styles.length})</div>
        <div class="style-tags">${styles.slice(0,14).map(s=>`<span class="style-tag">${esc(s)}</span>`).join('')}${styles.length>14?`<span class="style-tag" style="color:var(--muted)">+${styles.length-14} more</span>`:''}</div>
      </div>`:''}
    </div>
    ${renderSimilar(q,fabKey)}`;
}

function renderSimilar(q,exact){
  const entries=Object.entries(fabMap).filter(([k])=>k.includes(q)&&k!==exact).sort((a,b)=>b[1]-a[1]).slice(0,8);
  if(!entries.length)return'';
  const max=entries[0]?.[1]||1;
  return`<div class="list-hdr" style="margin-top:20px">
    <div class="list-hdr-title">Similar Codes</div>
  </div>
  <div class="ulist">${entries.map(([name,ct],i)=>{
    const bw=Math.round(ct/max*70);
    const po=poMap[name]?.po||'';
    return`<div class="uitem" onclick="selectFab('${esc(name)}')">
      <span class="u-rank">${i+1}</span>
      <div class="u-info"><div class="u-name">${esc(name)}</div>${po?`<div class="u-po">PO: ${esc(po)}</div>`:''}</div>
      <div class="u-right"><div class="u-bar" style="width:${bw}px;max-width:70px"></div><div class="u-ct">${ct}√ó</div></div>
    </div>`;
  }).join('')}</div>`;
}

loadData();
</script>
</body>
</html>
