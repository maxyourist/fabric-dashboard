<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fabric Inventory Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800&family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --navy:      #1a120a;
    --panel:     #221810;
    --panel2:    #2a1e14;
    --border:    rgba(104,199,193,0.18);
    --blue:      #68c7c1;
    --blue-lt:   #85d4cf;
    --blue-glow: rgba(104,199,193,0.2);
    --cyan:      #68c7c1;
    --teal:      #5ab5af;
    --text:      #f8f0e3;
    --text2:     #cdb99a;
    --muted:     #6b5240;
    --green:     #68c7c1;
    --red:       #f37d59;
    --yellow:    #faca78;
    --purple:    #dd5341;
    --pink:      #f37d59;
    --orange:    #f37d59;
    --rust:      #dd5341;
    --sand:      #f5ede0;
    --brown:     #764838;
  }
  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:var(--navy); color:var(--text);
    font-family:'Rajdhani',sans-serif; font-size:16px; line-height:1.6;
    min-height:100vh; overflow-x:hidden;
  }
  body::before {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background-image:
      linear-gradient(rgba(104,199,193,.06) 1px, transparent 1px),
      linear-gradient(90deg, rgba(104,199,193,.06) 1px, transparent 1px);
    background-size: 60px 60px;
  }
  body::after {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(ellipse 70% 50% at 10% 0%,   rgba(243,125,89,.07) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 90% 100%,  rgba(104,199,193,.08) 0%, transparent 60%),
      radial-gradient(ellipse 50% 35% at 50% 50%,   rgba(250,202,120,.04) 0%, transparent 60%);
  }
  .app { position:relative; z-index:1; }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 32px; border-bottom:1px solid var(--border);
    background:rgba(20,12,6,.97); backdrop-filter:blur(28px);
    position:sticky; top:0; z-index:100;
    box-shadow:0 1px 0 rgba(104,199,193,.2), 0 4px 32px rgba(0,0,0,.6);
  }
  .logo { display:flex; align-items:center; gap:13px; }
  .logo-icon { width:38px; height:38px; background:linear-gradient(135deg,#dd5341,#f37d59); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; box-shadow:0 0 20px var(--blue-glow); flex-shrink:0; }
  .logo-text h1 { font-size:15px; font-weight:600; letter-spacing:.06em; color:var(--sand); font-family:'Orbitron',sans-serif; text-transform:uppercase; }
  .logo-text p  { font-size:11px; color:var(--muted); font-family:'JetBrains Mono',monospace; letter-spacing:.04em; }
  .header-right { display:flex; align-items:center; gap:12px; }
  .live-badge { display:flex; align-items:center; gap:7px; font-size:12px; color:var(--text2); }
  .dot { width:7px; height:7px; border-radius:50%; background:#23c55e; box-shadow:0 0 8px #23c55e; animation:blink 2s infinite; flex-shrink:0; }
  .dot.loading { background:var(--yellow); box-shadow:0 0 8px var(--yellow); }
  .dot.error   { background:#f87070;    box-shadow:0 0 8px #f87070; animation:none; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }
  #lastUpdated { font-size:11px; color:var(--muted); font-family:'JetBrains Mono',monospace; }
  .refresh-btn { background:rgba(104,199,193,.12); border:1px solid var(--border); color:var(--blue-lt); padding:7px 16px; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; }
  .refresh-btn:hover { background:rgba(104,199,193,.22); border-color:var(--cyan); }
  .refresh-btn:disabled { opacity:.4; cursor:not-allowed; }

  /* â”€â”€ MAIN â”€â”€ */
  main { padding:22px 28px; max-width:1750px; margin:0 auto; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FILTER BAR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .filter-bar {
    background:var(--panel); border:1px solid var(--border);
    border-radius:12px; margin-bottom:14px; overflow:hidden;
  }

  /* ROW 1 â€” year + months (single scrollable row) */
  .filter-main-row {
    display:flex; align-items:center;
    padding:10px 16px; gap:0;
    overflow-x:auto; overflow-y:visible;
    scrollbar-width:none;
    position:relative;
  }
  .filter-main-row::-webkit-scrollbar { display:none; }

  .f-label {
    font-size:11px; font-weight:700; text-transform:uppercase;
    letter-spacing:.1em; color:var(--muted); white-space:nowrap;
    flex-shrink:0; margin-right:8px;
  }
  .f-divider { width:1px; height:20px; background:var(--border); flex-shrink:0; margin:0 10px; }

  /* pill base */
  .f-pill {
    display:inline-flex; align-items:center; gap:4px;
    padding:4px 13px; border-radius:100px; font-size:12px; font-weight:500;
    border:1px solid var(--border); background:var(--panel2);
    color:var(--text2); cursor:pointer; user-select:none; white-space:nowrap;
    flex-shrink:0; transition:border-color .15s, background .15s, color .15s;
  }
  .f-pill:hover { border-color:rgba(100,160,255,.4); color:var(--text); }
  .f-pill.active { background:rgba(77,139,245,.2); border-color:var(--blue); color:#fff; }
  .f-pill.month-open { background:rgba(32,212,238,.15); border-color:var(--cyan); color:var(--cyan); }
  .f-pill.has-selected { border-color:rgba(32,212,238,.4); color:var(--cyan); }

  /* spacing between pills */
  .year-pill  { margin-right:5px; }
  .month-pill { margin-right:4px; transition:margin .35s cubic-bezier(.4,0,.2,1), border-color .15s, background .15s, color .15s; }

  /* week pills â€” inline, hidden by default, expand via width/opacity */
  .week-group {
    display:inline-flex; align-items:center; gap:4px;
    max-width:0; overflow:hidden; opacity:0;
    transition:max-width .4s cubic-bezier(.4,0,.2,1), opacity .3s, margin .35s;
    flex-shrink:0; margin-right:0;
    /* small visual gap separator */
  }
  .week-group.open {
    max-width:900px; opacity:1; margin-right:6px;
  }
  .week-group::before {
    content:''; display:block; width:1px; height:18px;
    background:var(--cyan); opacity:.3; flex-shrink:0; margin-right:4px;
  }

  .w-pill {
    display:inline-flex; align-items:center;
    padding:3px 10px; border-radius:100px; font-size:10px; font-weight:500;
    border:1px solid rgba(77,139,245,.22); background:rgba(104,199,193,.06);
    color:var(--text2); cursor:pointer; user-select:none; white-space:nowrap;
    flex-shrink:0; font-family:'JetBrains Mono',monospace;
    transition:all .15s;
  }
  .w-pill:hover  { background:rgba(77,139,245,.18); color:var(--text); border-color:var(--blue); }
  .w-pill.active { background:rgba(32,212,238,.18); border-color:var(--cyan); color:var(--cyan); }

  /* ROW 2 â€” search bar */
  .filter-search-row {
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    padding:8px 16px; border-top:1px solid var(--border);
    background:rgba(77,139,245,.02);
  }
  .f-search {
    background:var(--panel2); border:1px solid var(--border); border-radius:8px;
    padding:7px 14px; font-size:15px; color:var(--text);
    font-family:'Rajdhani',sans-serif; outline:none; transition:all .2s;
    width:240px; flex-shrink:0;
  }
  .f-search::placeholder { color:var(--muted); }
  .f-search:focus { border-color:var(--cyan); box-shadow:0 0 0 3px rgba(104,199,193,.18); }
  }
  .f-clear { background:none; border:none; color:var(--muted); font-size:12px; cursor:pointer; padding:4px 8px; border-radius:6px; font-family:'Rajdhani',sans-serif; transition:color .2s; }
  .f-clear:hover { color:var(--red); }
  .active-tag {
    display:inline-flex; align-items:center; gap:5px; padding:3px 10px;
    border-radius:100px; background:rgba(104,199,193,.1); border:1px solid rgba(104,199,193,.25);
    color:var(--cyan); font-size:11px; font-weight:600; font-family:'JetBrains Mono',monospace;
  }
  .active-tag button { background:none; border:none; color:var(--cyan); cursor:pointer; font-size:12px; padding:0 0 0 2px; line-height:1; }

  /* â”€â”€ KPIs â”€â”€ */
  .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:14px; margin-bottom:16px; }
  .kpi-card { background:linear-gradient(135deg,var(--panel) 0%,rgba(30,18,10,.98) 100%); border:1px solid var(--border); border-radius:14px; padding:20px 22px; position:relative; overflow:hidden; box-shadow:0 2px 16px rgba(0,0,0,.3); }
  .kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
  .kpi-c1::before { background:linear-gradient(90deg,#68c7c1,#5ab5af); }
  .kpi-c2::before { background:linear-gradient(90deg,#f37d59,#dd5341); }
  .kpi-c3::before { background:linear-gradient(90deg,#faca78,#f37d59); }
  .kpi-c4::before { background:linear-gradient(90deg,#764838,#dd5341); }
  .kpi-c5::before { background:linear-gradient(90deg,#dd5341,#f37d59); }
  .kpi-c6::before { background:linear-gradient(90deg,#faca78,#68c7c1); }

  /* â”€â”€ SUBTLE TRANSITIONS â”€â”€ */
  .kpi-card { transition:border-color .25s, box-shadow .25s; }
  .kpi-card:hover { border-color:rgba(100,160,255,.22); box-shadow:0 4px 24px rgba(0,0,0,.25); }
  .kpi-value.flash { transition:color .4s; }
  .panel:hover, .full-panel:hover { border-color:rgba(100,160,255,.18); transition:border-color .3s; }
  tbody tr:hover { background:rgba(104,199,193,.05) !important; transition:background .15s; }
  ::-webkit-scrollbar { width:4px; height:4px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--muted); border-radius:10px; }
  ::-webkit-scrollbar-thumb:hover { background:#f37d59; }
  .kpi-icon { position:absolute; top:14px; right:16px; font-size:20px; opacity:.18; }
  .kpi-label { font-size:11px; font-weight:500; text-transform:uppercase; letter-spacing:.1em; color:var(--text2); margin-bottom:8px; font-family:'Orbitron',sans-serif; }
  .kpi-value { font-size:24px; font-weight:600; letter-spacing:.01em; line-height:1.15; margin-bottom:5px; font-family:'Orbitron',sans-serif; }
  .kpi-sub   { font-size:13px; font-weight:500; color:var(--text2); }

  /* â”€â”€ FABRIC STATS â”€â”€ */
  .fabric-stats {
    background:var(--panel); border:1px solid rgba(77,139,245,.25);
    border-radius:12px; margin-bottom:18px; overflow:hidden;
    max-height:0; opacity:0;
    transition:max-height .4s cubic-bezier(.4,0,.2,1), opacity .3s, margin .3s;
  }
  .fabric-stats.visible { max-height:500px; opacity:1; }
  .fabric-stats-header {
    padding:13px 20px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
    background:linear-gradient(90deg,rgba(77,139,245,.08),rgba(32,212,238,.04));
  }
  .fabric-stats-title { font-size:14px; font-weight:700; color:var(--blue-lt); display:flex; align-items:center; gap:8px; }
  .fabric-code { font-family:'JetBrains Mono',monospace; font-size:16px; color:var(--cyan); }
  .fabric-stats-body { padding:18px 20px; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; }
  .stat-block-label { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); margin-bottom:6px; }
  .stat-block-value { font-size:18px; font-weight:700; color:var(--text); }
  .stat-block-value.mono { font-family:'JetBrains Mono',monospace; font-size:15px; color:var(--teal); }
  .stat-block-value.sm   { font-size:13px; font-weight:500; color:var(--text2); }
  .weeks-used-list  { display:flex; flex-wrap:wrap; gap:5px; margin-top:4px; }
  .week-used-tag    { font-size:10px; font-family:'JetBrains Mono',monospace; color:var(--blue-lt); background:rgba(77,139,245,.1); border:1px solid rgba(77,139,245,.2); padding:2px 7px; border-radius:4px; }
  .styles-used-list { display:flex; flex-wrap:wrap; gap:5px; margin-top:4px; }
  .style-used-tag   { font-size:11px; color:var(--purple); background:rgba(167,139,250,.1); border:1px solid rgba(167,139,250,.2); padding:2px 8px; border-radius:100px; }

  /* â”€â”€ SECTION LABEL â”€â”€ */
  .section-label { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); font-family:'Orbitron',sans-serif; margin:20px 0 10px; }

  /* â”€â”€ GRIDS â”€â”€ */
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px; }
  @media(max-width:1150px) { .grid-2,.grid-3 { grid-template-columns:1fr; } }

  /* â”€â”€ PANEL â”€â”€ */
  .panel { background:linear-gradient(160deg,var(--panel) 0%,rgba(28,16,8,.98) 100%); border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:0 2px 20px rgba(0,0,0,.25); }
  .panel-header { padding:13px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .panel-title { font-size:11px; font-weight:600; color:var(--text); font-family:'Orbitron',sans-serif; letter-spacing:.05em; text-transform:uppercase; }
  .panel-tag { font-size:11px; font-family:'JetBrains Mono',monospace; color:var(--blue-lt); background:rgba(77,139,245,.1); padding:2px 8px; border-radius:4px; border:1px solid rgba(77,139,245,.2); }
  .panel-body { padding:16px 18px; }
  .chart-wrap { position:relative; height:230px; }

  /* â”€â”€ USAGE LOOKUP â”€â”€ */
  .usage-search-row { display:flex; gap:8px; margin-bottom:12px; }
  .usage-search { background:var(--panel2); border:1px solid var(--border); border-radius:8px; padding:7px 12px; font-size:13px; color:var(--text); font-family:'Rajdhani',sans-serif; outline:none; transition:all .2s; flex:1; }
  .usage-search::placeholder { color:var(--muted); }
  .usage-search:focus { border-color:var(--blue); box-shadow:0 0 0 3px var(--blue-glow); }
  .mode-toggle { display:flex; background:var(--panel2); border:1px solid var(--border); border-radius:8px; overflow:hidden; flex-shrink:0; }
  .mode-btn { background:none; border:none; color:var(--text2); padding:6px 14px; font-size:12px; font-weight:600; cursor:pointer; transition:all .18s; font-family:'Rajdhani',sans-serif; }
  .mode-btn.active { background:rgba(104,199,193,.2); color:var(--cyan); border-color:var(--cyan); }
  .usage-list { display:flex; flex-direction:column; gap:5px; max-height:270px; overflow-y:auto; }
  .usage-list::-webkit-scrollbar { width:4px; }
  .usage-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
  .usage-row { display:flex; align-items:center; gap:10px; padding:7px 10px; border-radius:8px; background:var(--panel2); border:1px solid transparent; transition:border-color .15s; }
  .usage-row:hover { border-color:var(--border); }
  .usage-rank { font-size:10px; color:var(--muted); font-family:'JetBrains Mono',monospace; width:22px; text-align:right; flex-shrink:0; }
  .usage-name { font-size:15px; font-weight:500; flex:1; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .usage-bar-wrap { display:flex; align-items:center; gap:8px; flex-shrink:0; }
  .usage-bar { height:5px; border-radius:3px; background:linear-gradient(90deg,#f37d59,#faca78); }
  .usage-count { font-size:12px; font-weight:600; color:var(--blue-lt); font-family:'JetBrains Mono',monospace; width:34px; text-align:right; }
  .no-results { text-align:center; padding:24px; color:var(--muted); font-size:13px; }

  /* â”€â”€ TOP 10 â”€â”€ */
  .top10-list { display:flex; flex-direction:column; gap:7px; }
  .top10-row  { display:flex; align-items:center; gap:10px; }
  .top10-num  { font-size:12px; font-weight:700; color:var(--muted); width:22px; text-align:center; flex-shrink:0; font-family:'JetBrains Mono',monospace; }
  .top10-num.r1 { color:var(--yellow); font-size:15px; }
  .top10-num.r2 { color:#94a3b8; font-size:14px; }
  .top10-num.r3 { color:#cd7c3a; font-size:13px; }
  .top10-info   { flex:1; min-width:0; }
  .top10-name   { font-size:15px; font-weight:600; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .top10-bar    { height:3px; border-radius:2px; background:linear-gradient(90deg,#f37d59,#faca78); margin-top:4px; }
  .top10-count  { font-size:13px; font-weight:700; color:var(--cyan); font-family:'JetBrains Mono',monospace; flex-shrink:0; }

  /* â”€â”€ TABLE â”€â”€ */
  .full-panel { background:linear-gradient(160deg,var(--panel) 0%,rgba(28,16,8,.98) 100%); border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-bottom:20px; box-shadow:0 2px 20px rgba(0,0,0,.25); }
  .table-wrap { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; font-size:14px; font-weight:500; }
  thead th { background:rgba(42,24,12,.9); padding:10px 14px; text-align:left; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.07em; color:var(--text2); border-bottom:1px solid var(--border); white-space:nowrap; cursor:pointer; user-select:none; transition:color .15s; }
  thead th:hover { color:var(--blue-lt); }
  tbody tr { border-bottom:1px solid rgba(100,160,255,.05); transition:background .12s; }
  tbody tr:hover { background:rgba(104,199,193,.05); }
  tbody td { padding:9px 14px; color:var(--text); white-space:nowrap; }
  .badge { display:inline-flex; align-items:center; gap:4px; padding:3px 9px; border-radius:100px; font-size:11px; font-weight:600; }
  .badge-ok  { background:rgba(35,197,94,.12); color:var(--green); border:1px solid rgba(35,197,94,.25); }
  .badge-buy { background:rgba(251,191,36,.12); color:var(--yellow); border:1px solid rgba(251,191,36,.25); }
  .sheet-tag { display:inline-block; background:rgba(77,139,245,.1); color:var(--blue-lt); border:1px solid rgba(77,139,245,.2); padding:2px 8px; border-radius:5px; font-size:11px; font-family:'JetBrains Mono',monospace; }
  .count-pill { display:inline-block; padding:2px 8px; border-radius:100px; font-size:11px; font-weight:600; font-family:'JetBrains Mono',monospace; }
  .count-fab   { background:rgba(32,212,238,.1); color:var(--cyan); border:1px solid rgba(32,212,238,.22); }
  .count-style { background:rgba(167,139,250,.1); color:var(--purple); border:1px solid rgba(167,139,250,.22); }
  .po-tag { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--teal); }
  .pagination { display:flex; align-items:center; justify-content:space-between; padding:12px 18px; border-top:1px solid var(--border); font-size:12px; color:var(--text2); }
  .page-btns { display:flex; gap:4px; }
  .page-btn { background:var(--panel2); border:1px solid var(--border); color:var(--text); width:30px; height:30px; border-radius:6px; cursor:pointer; font-size:12px; transition:all .15s; display:flex; align-items:center; justify-content:center; }
  .page-btn:hover,.page-btn.active { background:#f37d59; border-color:var(--blue); color:#fff; }
  .page-btn:disabled { opacity:.3; cursor:not-allowed; }

  /* STATES */
  .loading-state { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:60px; gap:14px; }
  .spinner { width:36px; height:36px; border:3px solid var(--border); border-top-color:var(--blue); border-radius:50%; animation:spin .7s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { font-size:13px; color:var(--text2); }
  .error-msg { padding:32px; text-align:center; font-size:13px; color:var(--red); line-height:2; }
  .empty-msg { padding:28px; text-align:center; font-size:13px; color:var(--muted); }
</style>
</head>
<body>
<div class="app">

<header>
  <div class="logo">
    <div class="logo-icon">ğŸ§µ</div>
    <div class="logo-text">
      <h1>Fabric Inventory Dashboard</h1>
      <p>LIVE Â· GOOGLE SHEETS</p>
    </div>
  </div>
  <div class="header-right">
    <div class="live-badge">
      <div class="dot loading" id="dot"></div>
      <span id="statusText">Connecting...</span>
    </div>
    <span id="lastUpdated"></span>
    <button class="refresh-btn" id="refreshBtn" onclick="loadData()">â†» Refresh</button>
  </div>
</header>

<main>

  <!-- FILTER BAR -->
  <div class="filter-bar">
    <!-- ROW 1: Year | Month pills with inline week expansion -->
    <div class="filter-main-row" id="filterMainRow">
      <span class="f-label">YEAR</span>
      <div id="yearPills"></div>
      <div class="f-divider"></div>
      <span class="f-label">MONTH</span>
      <div id="monthPills" style="display:inline-flex;align-items:center;gap:0;"></div>
    </div>
    <!-- ROW 2: Search -->
    <div class="filter-search-row">
      <input class="f-search" id="searchInput" type="text" placeholder="Fabric number, style, vendor..." oninput="onSearch()">

      <div id="activeWeekTag"></div>
      <button class="f-clear" onclick="clearAll()">âœ• Clear</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid" id="kpiGrid">
    <div class="kpi-card kpi-c1"><div class="kpi-label">Loading...</div></div>
  </div>

  <!-- FABRIC STATS -->
  <div class="fabric-stats" id="fabricStats">
    <div class="fabric-stats-header">
      <div class="fabric-stats-title">
        Fabric <span class="fabric-code" id="statsFabricCode"></span> â€” All-Time Stats
      </div>
    </div>
    <div class="fabric-stats-body" id="fabricStatsBody"></div>
  </div>

  <!-- USAGE + TOP 10 -->
  <div id="usageSection">
  <p class="section-label">Fabric &amp; Style Usage</p>
  <div class="grid-3">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Usage Lookup</span>
        <div class="mode-toggle">
          <button class="mode-btn active" id="btnFabric" onclick="setMode('fabric')">Fabric</button>
          <button class="mode-btn"        id="btnStyle"  onclick="setMode('style')">Style</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="usage-search-row">
          <input class="usage-search" id="usageSearch" type="text" placeholder="Type a fabric number..." oninput="renderUsageList()">
        </div>
        <div class="usage-list" id="usageList"></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Top 10 Styles</span><span class="panel-tag">BY USE COUNT</span></div>
      <div class="panel-body"><div class="top10-list" id="top10Styles"></div></div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Top 10 Fabrics</span><span class="panel-tag">BY USE COUNT</span></div>
      <div class="panel-body"><div class="top10-list" id="top10Fabrics"></div></div>
    </div>
  </div>
  </div><!-- /usageSection -->

  <!-- CHARTS -->
  <p class="section-label">Charts</p>
  <div class="grid-2">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Most Used Styles</span><span class="panel-tag">COUNT</span></div>
      <div class="panel-body"><div class="chart-wrap"><canvas id="chartStyles"></canvas></div></div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Most Used Fabrics</span><span class="panel-tag">COUNT</span></div>
      <div class="panel-body"><div class="chart-wrap"><canvas id="chartFabrics"></canvas></div></div>
    </div>
  </div>
  <div style="margin-top:16px;margin-bottom:16px;">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Top Fabric Usage Over Time</span><span class="panel-tag">WEEKLY TREND â€” TOP 5</span></div>
      <div class="panel-body"><div class="chart-wrap" style="height:200px;"><canvas id="chartTrend"></canvas></div></div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="full-panel" id="tablePanel">
    <div class="panel-header" onclick="toggleTable()" style="cursor:pointer;user-select:none;">
      <div style="display:flex;align-items:center;gap:10px;">
        <span class="panel-title">Data Table</span>
        <span id="tableCount" style="font-size:12px;color:var(--text2);"></span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:12px;color:var(--text2);" id="tableToggleHint">Click to expand</span>
        <span id="tableChevron" style="color:var(--text2);font-size:14px;transition:transform .25s;">â–¾</span>
      </div>
    </div>
    <div id="tableCollapsible" style="display:none;">
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th onclick="doSort('sheet')">Week â†•</th>
          <th onclick="doSort('vendor')">Vendor â†•</th>
          <th onclick="doSort('style')">Style â†•</th>
          <th onclick="doSort('fabricNorm')">Fabric â†•</th>
          <th onclick="doSort('supplier_fab')">Supplier Fabric â†•</th>
          <th onclick="doSort('quantity')">Qty â†•</th>
          <th onclick="doSort('yield')">Yield â†•</th>
          <th onclick="doSort('yardage')">Yardage â†•</th>
          <th onclick="doSort('stock')">Stock â†•</th>
          <th onclick="doSort('fabricUses')">Fabric Uses â†•</th>
          <th onclick="doSort('styleUses')">Style Uses â†•</th>
          <th onclick="doSort('latestPO')">Latest Fabric PO â†•</th>
          <th onclick="doSort('status')">Status â†•</th>
        </tr></thead>
        <tbody id="tableBody">
          <tr><td colspan="13"><div class="loading-state"><div class="spinner"></div><div class="loading-text">Loading fabric data...</div></div></td></tr>
        </tbody>
      </table>
    </div>
    <div class="pagination">
      <span id="pageInfo">â€”</span>
      <div class="page-btns" id="pageBtns"></div>
    </div>
    </div><!-- /tableCollapsible -->
  </div>

</main>
</div>

<script>
const SCRIPT_URL = 'https://icy-king-649a.myourist.workers.dev';
const PAGE_SIZE  = 25;
const REFRESH_MS = 60000;
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

let allRows = [], filteredRows = [];
let selectedYears  = new Set();
let selectedWeeks  = new Set();
let openMonthKey   = null; // "2025-9"
let page = 1, sortKey = 'sheet', sortDir = -1;
let charts = {}, usageMode = 'fabric';

// Global maps
let fabricUseMap  = {};
let styleUseMap   = {};
let latestPOMap   = {};
let fabricMetaMap = {};

// SWAT code -> factory code lookup (from FABRIC CODES tab)
let swatMap = {};    // SWAT code -> factory code
let factoryMap = {}; // factory code (uppercase) -> [SWAT codes]

// Keyed month data: "2025-9" -> { year, month, sheets[] }
let monthData = {};

function normFab(s) { return String(s||'').trim().toUpperCase(); }

// â”€â”€ LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  setStatus('loading','Fetching data...');
  document.getElementById('refreshBtn').disabled = true;
  try {
    const res  = await fetch(SCRIPT_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (!json.success) throw new Error('Script error.');

    const dateRx = /\d+\/\d+/;
    const sheetNames = Object.keys(json.data).filter(n => dateRx.test(n));
    allRows = sheetNames.flatMap(name => parseSheet(json.data[name], name));

    // Build SWAT â†’ factory code map from FABRIC CODES tab
    swatMap = {};
    const fabricCodesData = json.data['FABRIC CODES'];
    if (fabricCodesData) {
      fabricCodesData.forEach(row => {
        const factoryCode = String(row[0] || '').trim(); // col A
        if (!factoryCode) return;
        // cols B, C, D, E (indices 1-4) are SWAT codes
        for (let i = 1; i <= 4; i++) {
          const swat = String(row[i] || '').trim().toUpperCase();
          if (swat) {
            swatMap[swat] = factoryCode;
            const fcu = factoryCode.toUpperCase();
            if (!factoryMap[fcu]) factoryMap[fcu] = [];
            factoryMap[fcu].push(swat);
          }
        }
      });
    }

    // Global maps
    fabricUseMap = {}; styleUseMap = {}; latestPOMap = {}; fabricMetaMap = {};

    // Pass 1: counts, meta, collect ALL po entries per fabric
    const allPOEntries = {}; // nf -> [{po, sheet, dateVal}]
    allRows.forEach(r => {
      const nf = normFab(r.fabric);
      if (nf) {
        fabricUseMap[nf] = (fabricUseMap[nf]||0) + 1;
        if (!fabricMetaMap[nf]) fabricMetaMap[nf] = { weeks:new Set(), styles:new Set(), vendors:new Set(), firstWeek:r.sheet };
        const m = fabricMetaMap[nf];
        m.weeks.add(r.sheet);
        if (r.style)  m.styles.add(r.style);
        if (r.vendor) m.vendors.add(r.vendor);
        if (sheetDateVal(r.sheet) < sheetDateVal(m.firstWeek)) m.firstWeek = r.sheet;
        // Collect every PO entry â€” pick the true latest after all rows are seen
        const rawPO = r.fab_po ? r.fab_po.replace(/^po[^\d]*/i, '').trim() : '';
        if (rawPO && /^\d+$/.test(rawPO)) {  // strip 'PO' + any separators, keep if purely numeric
          if (!allPOEntries[nf]) allPOEntries[nf] = [];
          allPOEntries[nf].push({ po: rawPO, sheet: r.sheet, dateVal: sheetDateVal(r.sheet) });
        }
      }
      if (r.style) styleUseMap[r.style] = (styleUseMap[r.style]||0) + 1;
    });

    // Pass 2: for each fabric pick the PO from the highest dateVal sheet
    Object.entries(allPOEntries).forEach(([nf, entries]) => {
      entries.sort((a, b) => b.dateVal - a.dateVal);
      latestPOMap[nf] = { po: entries[0].po, sheet: entries[0].sheet };
      console.log('[PO]', nf, '->', entries[0].po, 'from', entries[0].sheet, '(dateVal:', entries[0].dateVal, ')');
    });
    allRows.forEach(r => {
      r.fabricNorm = normFab(r.fabric);
      r.fabricUses = fabricUseMap[r.fabricNorm] || 0;
      r.styleUses  = styleUseMap[r.style]  || 0;
      r.latestPO   = latestPOMap[r.fabricNorm]?.po || '';
    });

    // Build monthData
    monthData = {};
    sheetNames.forEach(name => {
      const { year, month } = parseSheetDate(name);
      if (!year||!month) return;
      const key = `${year}-${month}`;
      if (!monthData[key]) monthData[key] = { year, month, sheets:[] };
      monthData[key].sheets.push(name);
    });
    Object.values(monthData).forEach(m => m.sheets.sort((a, b) => sheetDateVal(b) - sheetDateVal(a)));

    buildFilterUI();
    applyFilters();
    setStatus('live', `Live Â· ${allRows.length} lines`);
    document.getElementById('lastUpdated').textContent = 'Updated ' + new Date().toLocaleTimeString();
  } catch(err) {
    setStatus('error','Connection error');
    document.getElementById('tableBody').innerHTML =
      `<tr><td colspan="13"><div class="error-msg">âŒ ${err.message}</div></td></tr>`;
    console.error(err);
  }
  document.getElementById('refreshBtn').disabled = false;
}

// â”€â”€ SHEET DATE VALUE helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sheetDateVal(name) {
  // Parses tab names like "2/3 - 2/7/2026" or "9/2 - 9/5/2025"
  // Returns a comparable integer: YYYYMMDD of the END date in the range
  if (!name) return 0;
  const yearM = name.match(/\b(20\d{2})\b/);
  const year  = yearM ? parseInt(yearM[1]) : 0;
  // Split on ' - ' to get the end segment e.g. "2/7/2026" or "9/5/2025"
  const parts = name.split(/\s*-\s*/);
  // Use the last date-like segment
  let month = 0, day = 0;
  for (let i = parts.length - 1; i >= 0; i--) {
    const dm = parts[i].match(/(\d{1,2})\/(\d{1,2})/);
    if (dm) { month = parseInt(dm[1]); day = parseInt(dm[2]); break; }
  }
  return year * 10000 + month * 100 + day;
}

// â”€â”€ PARSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseSheet(grid, sheetName) {
  if (!grid || grid.length < 2) return [];
  let hi = 0;
  for (let i = 0; i < Math.min(6, grid.length); i++) {
    if (grid[i].map(c=>String(c).toLowerCase()).includes('style')) { hi=i; break; }
  }
  const headers = grid[hi].map(c=>String(c).toLowerCase().trim());
  const col = (row,name) => { const i=headers.indexOf(name); return i>=0?String(row[i]??'').trim():''; };
  const num = (row,name) => parseFloat(col(row,name))||0;
  const { year, month } = parseSheetDate(sheetName);
  return grid.slice(hi+1).filter(r=>col(r,'style')).map(r => {
    let status='';
    for (const cell of r) {
      const v=String(cell??'').toLowerCase().trim();
      if (v==='ok'){status='ok';break;}
      if (v.startsWith('buy')){status=v;break;}
    }
    return { sheet:sheetName, year, month,
      vendor:col(r,'vendor'), style:col(r,'style'), fabric:col(r,'fab'),
      supplier_fab:col(r,'supplier fab')||col(r,'supplier_fab'),
      quantity:num(r,'quantity'), yield:num(r,'yield'), yardage:num(r,'yardage'),
      totals:num(r,'totals'), stock:num(r,'stock'),
      fab_po:col(r,'fab po')||col(r,'fab_po'), status,
      fabricNorm:'', fabricUses:0, styleUses:0, latestPO:'' };
  });
}

function parseSheetDate(name) {
  const ym=name.match(/\b(20\d{2})\b/), mm=name.match(/(\d{1,2})\//);
  return { year:ym?parseInt(ym[1]):null, month:mm?parseInt(mm[1]):null };
}

// â”€â”€ BUILD FILTER UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFilterUI() {
  // Years
  const years = [...new Set(allRows.map(r=>r.year).filter(Boolean))].sort();
  document.getElementById('yearPills').innerHTML = years.map(y =>
    `<span class="f-pill year-pill ${selectedYears.has(y)?'active':''}" onclick="toggleYear(${y})">${y}</span>`
  ).join('');

  // Months â€” build inline with week groups
  // Sorted month keys
  const sortedKeys = Object.keys(monthData).sort((a,b) => {
    const [ay,am]=a.split('-').map(Number), [by,bm]=b.split('-').map(Number);
    return ay!==by?ay-by:am-bm;
  }).filter(key => {
    // filter by selected years if any
    const { year } = monthData[key];
    return !selectedYears.size || selectedYears.has(year);
  });

  const container = document.getElementById('monthPills');
  container.innerHTML = '';

  sortedKeys.forEach(key => {
    const { month, sheets } = monthData[key];
    const isOpen = openMonthKey === key;
    const hasSelected = sheets.some(s => selectedWeeks.has(s));

    // Month pill
    const pill = document.createElement('span');
    pill.className = `f-pill month-pill${isOpen?' month-open':''}${hasSelected&&!isOpen?' has-selected':''}`;
    pill.textContent = MONTH_NAMES[month-1];
    pill.onclick = () => toggleMonth(key);
    container.appendChild(pill);

    // Week group (inline, expands/collapses)
    const wg = document.createElement('span');
    wg.className = `week-group${isOpen?' open':''}`;
    wg.id = `wg-${key}`;
    sheets.forEach(s => {
      const wp = document.createElement('span');
      wp.className = `w-pill${selectedWeeks.has(s)?' active':''}`;
      wp.textContent = s;
      wp.onclick = (e) => { e.stopPropagation(); toggleWeek(s, key); };
      wg.appendChild(wp);
    });
    container.appendChild(wg);
  });
}

function toggleYear(y) {
  selectedYears.has(y) ? selectedYears.delete(y) : selectedYears.add(y);
  selectedWeeks.clear(); openMonthKey = null;
  buildFilterUI(); applyFilters();
}

function toggleMonth(key) {
  openMonthKey = openMonthKey === key ? null : key;
  buildFilterUI();
}

function toggleWeek(sheet, key) {
  selectedWeeks.has(sheet) ? selectedWeeks.delete(sheet) : selectedWeeks.add(sheet);
  openMonthKey = key; // keep month open
  buildFilterUI();
  renderActiveWeekTag();
  applyFilters();
}

function renderActiveWeekTag() {
  const el = document.getElementById('activeWeekTag');
  if (!selectedWeeks.size) { el.innerHTML=''; return; }
  const label = selectedWeeks.size===1
    ? `Week: ${[...selectedWeeks][0]}`
    : `${selectedWeeks.size} weeks selected`;
  el.innerHTML = `<div class="active-tag">${esc(label)}<button onclick="clearWeeks()">âœ•</button></div>`;
}

function clearWeeks() { selectedWeeks.clear(); openMonthKey=null; buildFilterUI(); renderActiveWeekTag(); applyFilters(); }

function clearAll() {
  selectedYears.clear(); selectedWeeks.clear(); openMonthKey=null;
  document.getElementById('searchInput').value='';
  document.getElementById('usageSearch').value='';
  const us=document.getElementById('usageSection'); if(us) us.style.display='';
  buildFilterUI(); renderActiveWeekTag(); renderUsageList();
  document.getElementById('fabricStats').classList.remove('visible');
  applyFilters();
}

// â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onSearch() {
  applyFilters();
  renderFabricStats();
  const sq = document.getElementById('searchInput').value.trim();
  const us = document.getElementById('usageSection');
  if (us) us.style.display = sq ? 'none' : '';
}

// â”€â”€ FABRIC STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFabricStats() {
  const q   = document.getElementById('searchInput').value.trim().toUpperCase();
  const box = document.getElementById('fabricStats');
  if (!q) { box.classList.remove('visible'); return; }
  // Style search is handled entirely in renderKPIs â€” skip here
  const isStyle = Object.keys(styleUseMap).find(k=>k===q) || Object.keys(styleUseMap).find(k=>k.includes(q));
  if (isStyle) return;

  // Support factory code search: if sq matches a factory code, find its SWAT codes and use first match
  const factorySwats = factoryMap[q] || Object.entries(factoryMap).find(([k])=>k.includes(q))?.[1];
  const resolvedQ = (factorySwats && factorySwats.length) ? factorySwats[0] : q;
  const mk = Object.keys(fabricUseMap).find(k=>k===resolvedQ) || Object.keys(fabricUseMap).find(k=>k.includes(resolvedQ)) ||
             Object.keys(fabricUseMap).find(k=>k===q) || Object.keys(fabricUseMap).find(k=>k.includes(q));
  if (!mk) { box.classList.remove('visible'); return; }

  const meta   = fabricMetaMap[mk] || {};
  const uses   = fabricUseMap[mk]  || 0;
  const lastPO = latestPOMap[mk];
  const weeks  = meta.weeks  ? [...meta.weeks].sort()  : [];
  const styles = meta.styles ? [...meta.styles] : [];
  const first  = meta.firstWeek || 'â€”';

  document.getElementById('statsFabricCode').textContent = mk;
  document.getElementById('fabricStatsBody').innerHTML = `
    <div class="stat-block">
      <div class="stat-block-label">Times Used</div>
      <div class="stat-block-value" style="color:var(--cyan);font-family:'JetBrains Mono',monospace;font-size:22px;">${uses}Ã—</div>
    </div>
    <div class="stat-block">
      <div class="stat-block-label">Last Fabric PO</div>
      <div class="stat-block-value mono">${lastPO?esc(lastPO.po):'â€”'}</div>
      ${lastPO?`<div style="font-size:11px;color:var(--muted);margin-top:3px;">week of ${esc(lastPO.sheet)}</div>`:''}
    </div>
    <div class="stat-block">
      <div class="stat-block-label">First Used</div>
      <div class="stat-block-value sm">${esc(first)}</div>
    </div>
    <div class="stat-block">
      <div class="stat-block-label">Associated Styles (${styles.length})</div>
      <div class="styles-used-list">
        ${styles.slice(0,12).map(s=>`<span class="style-used-tag">${esc(s)}</span>`).join('')}
        ${styles.length>12?`<span style="font-size:11px;color:var(--muted)">+${styles.length-12} more</span>`:''}
      </div>
    </div>
    <div class="stat-block" style="grid-column:1/-1">
      <div class="stat-block-label">Weeks It Appeared In (${weeks.length})</div>
      <div class="weeks-used-list">${weeks.map(w=>`<span class="week-used-tag">${esc(w)}</span>`).join('')}</div>
    </div>`;
  box.classList.add('visible');
}

// â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() {
  const q  = document.getElementById('searchInput').value.toLowerCase();
  filteredRows = allRows.filter(r => {
    if (selectedYears.size && !selectedYears.has(r.year)) return false;
    if (selectedWeeks.size && !selectedWeeks.has(r.sheet)) return false;
    if (q && !`${r.style}${r.fabricNorm}${r.vendor}${r.supplier_fab}`.toLowerCase().includes(q)) return false;
    return true;
  });
  if (sortKey) {
    filteredRows.sort((a,b)=>{
      const av=a[sortKey]??'',bv=b[sortKey]??'';
      return (typeof av==='number'?av-bv:String(av).localeCompare(String(bv)))*sortDir;
    });
  }
  page=1;
  renderKPIs(); renderUsageList(); renderTop10(); renderCharts(); renderTable();
}

function doSort(key){sortDir=sortKey===key?-sortDir:1;sortKey=key;applyFilters();}

// â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIs() {
  const r = filteredRows;
  const uniqueFabrics = new Set(r.map(x=>x.fabricNorm).filter(Boolean)).size;
  const sq = document.getElementById('searchInput').value.trim().toUpperCase();

  // â”€â”€ Detect if sq matches a style â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const styleKey = sq ? (Object.keys(styleUseMap).find(k=>k===sq) || Object.keys(styleUseMap).find(k=>k.includes(sq))) : null;

  // â”€â”€ STYLE SEARCH MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (styleKey) {
    const styleRows  = allRows.filter(r => r.style === styleKey);
    const usageCount = styleUseMap[styleKey] || 0;
    const totalUnits = styleRows.reduce((s,x) => s + x.quantity, 0);

    // Per-fabric breakdown: units, yields, count
    const fabData = {};
    styleRows.forEach(r => {
      const nf = r.fabricNorm; if (!nf) return;
      if (!fabData[nf]) fabData[nf] = { units:0, yields:[], rows:0 };
      fabData[nf].rows++;
      fabData[nf].units += r.quantity || 0;
      if (r.yield) fabData[nf].yields.push(r.yield);
    });
    const fabEntries = Object.entries(fabData).sort((a,b) => b[1].rows - a[1].rows);

    // KPI cards
    const uniqueFabsCard = `<div class="kpi-card kpi-c1"><div class="kpi-icon">ğŸ§µ</div><div class="kpi-label">Unique Fabrics</div><div class="kpi-value flash" style="color:var(--blue-lt)">${fabEntries.length}</div><div class="kpi-sub">used with ${esc(styleKey)}</div></div>`;
    const unitsCard      = `<div class="kpi-card kpi-c2"><div class="kpi-icon">ğŸ“¦</div><div class="kpi-label">Total Units</div><div class="kpi-value flash" style="color:var(--cyan)">${totalUnits.toLocaleString()}</div><div class="kpi-sub">all time Â· ${esc(styleKey)}</div></div>`;
    const usageCard      = `<div class="kpi-card kpi-c4"><div class="kpi-icon">ğŸ“Š</div><div class="kpi-label">Usage Count</div><div class="kpi-value flash" style="color:var(--yellow)">${usageCount}Ã—</div><div class="kpi-sub">appearances in weekly sheets</div></div>`;
    document.getElementById('kpiGrid').innerHTML = uniqueFabsCard + unitsCard + usageCard;

    // Fabric breakdown table in the stats panel
    const box = document.getElementById('fabricStats');
    document.getElementById('statsFabricCode').textContent = styleKey;
    const rows = fabEntries.map(([fab, d]) => {
      const avgYield = d.yields.length ? (d.yields.reduce((s,v)=>s+v,0)/d.yields.length).toFixed(2) : 'â€”';
      return `<tr style="border-bottom:1px solid rgba(104,199,193,.07);">
        <td style="padding:9px 12px;font-family:'JetBrains Mono',monospace;color:var(--cyan);font-weight:600;">${esc(fab)}</td>
        <td style="padding:9px 12px;text-align:center;color:var(--text2);">${avgYield}</td>
        <td style="padding:9px 12px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--text);">${d.units.toLocaleString()}</td>
        <td style="padding:9px 12px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--text2);">${d.rows}Ã—</td>
      </tr>`;
    }).join('');

    document.getElementById('fabricStatsBody').innerHTML = `
      <div style="overflow-x:auto;padding:4px 0;">
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <thead><tr style="border-bottom:1px solid var(--border);">
            <th style="text-align:left;padding:8px 12px;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-family:'Orbitron',sans-serif;font-weight:500;">Fabric</th>
            <th style="text-align:center;padding:8px 12px;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-family:'Orbitron',sans-serif;font-weight:500;">Avg Yield</th>
            <th style="text-align:right;padding:8px 12px;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-family:'Orbitron',sans-serif;font-weight:500;">Units</th>
            <th style="text-align:right;padding:8px 12px;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-family:'Orbitron',sans-serif;font-weight:500;">Count</th>
          </tr></thead>
          <tbody>${rows || '<tr><td colspan="4" style="color:var(--muted);padding:12px;">No fabric data found</td></tr>'}</tbody>
        </table>
      </div>`;
    box.classList.add('visible');
    return;
  }

  // â”€â”€ FABRIC / FACTORY SEARCH MODE (original) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Last Fabric PO
  let poVal = '', poSub = 'Search a fabric number';
  if (sq) {
    const mk = Object.keys(latestPOMap).find(k=>k===sq) || Object.keys(latestPOMap).find(k=>k.includes(sq));
    if (mk && latestPOMap[mk]) { poVal = latestPOMap[mk].po; poSub = `Week of ${latestPOMap[mk].sheet}`; }
    else { poVal = 'â€”'; poSub = `No PO found for "${sq}"`; }
  }

  // Factory code (bidirectional)
  let factoryVal = '', factorySub = 'Search a SWAT or factory code';
  if (sq) {
    const bySwat    = swatMap[sq] || Object.entries(swatMap).find(([k]) => k.includes(sq))?.[1];
    const byFactory = factoryMap[sq] || Object.entries(factoryMap).find(([k]) => k.includes(sq))?.[1];
    if (bySwat)         { factoryVal = bySwat;               factorySub = `Factory code for SWAT ${sq}`; }
    else if (byFactory) { factoryVal = byFactory.join(', '); factorySub = `SWAT codes for factory ${sq}`; }
    else                { factoryVal = 'â€”';                  factorySub = `No match for "${sq}"`; }
  }

  // Total units + yardage for searched fabric
  let unitsCard = '', yardageCard = '';
  if (sq) {
    const byFactory  = factoryMap[sq] || Object.entries(factoryMap).find(([k])=>k.includes(sq))?.[1];
    const resolvedSQ = (byFactory && !swatMap[sq]) ? (byFactory[0] || sq) : sq;
    const mk = Object.keys(fabricUseMap).find(k=>k===resolvedSQ)
            || Object.keys(fabricUseMap).find(k=>k.includes(resolvedSQ))
            || Object.keys(fabricUseMap).find(k=>k===sq)
            || Object.keys(fabricUseMap).find(k=>k.includes(sq));
    if (mk) {
      const fabRows      = allRows.filter(r=>r.fabricNorm===mk);
      const totalUnits   = fabRows.reduce((s,x)=>s+x.quantity, 0);
      const totalYardage = fabRows.reduce((s,x)=>s+x.yardage,  0);
      unitsCard   = `<div class="kpi-card kpi-c2"><div class="kpi-icon">ğŸ“¦</div><div class="kpi-label">Total Units</div><div class="kpi-value flash" style="color:var(--cyan)">${totalUnits.toLocaleString()}</div><div class="kpi-sub">all time for ${esc(mk)}</div></div>`;
      yardageCard = `<div class="kpi-card kpi-c6"><div class="kpi-icon">ğŸª¡</div><div class="kpi-label">Total Yardage</div><div class="kpi-value flash" style="color:var(--yellow)">${totalYardage.toLocaleString(undefined,{maximumFractionDigits:1})}</div><div class="kpi-sub">col H Â· all time for ${esc(mk)}</div></div>`;
    }
  }

  const uniqueFabsCard = sq ? '' : `<div class="kpi-card kpi-c1"><div class="kpi-icon">ğŸ§µ</div><div class="kpi-label">Unique Fabrics</div><div class="kpi-value" style="color:var(--blue-lt)">${uniqueFabrics.toLocaleString()}</div><div class="kpi-sub">distinct fabric codes</div></div>`;

  document.getElementById('kpiGrid').innerHTML = `
    ${uniqueFabsCard}
    ${unitsCard}
    ${yardageCard}
    <div class="kpi-card kpi-c4"><div class="kpi-icon">ğŸ“‹</div><div class="kpi-label">Last Fabric PO</div>
      <div class="kpi-value" style="color:${poVal&&poVal!=='â€”'?'var(--teal)':'var(--muted)'};font-size:${poVal.length>10?'15px':'22px'};font-family:'JetBrains Mono',monospace;">${poVal||'â€”'}</div>
      <div class="kpi-sub">${esc(poSub)}</div></div>
    <div class="kpi-card kpi-c5"><div class="kpi-icon">ğŸ·ï¸</div><div class="kpi-label">Factory Code</div>
      <div class="kpi-value" style="color:${factoryVal&&factoryVal!=='â€”'?'var(--pink)':'var(--muted)'};font-size:${factoryVal.length>10?'15px':'22px'};font-family:'JetBrains Mono',monospace;">${factoryVal||'â€”'}</div>
      <div class="kpi-sub">${esc(factorySub)}</div></div>`;
}

// â”€â”€ USAGE LOOKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(m){
  usageMode=m;
  document.getElementById('btnFabric').classList.toggle('active',m==='fabric');
  document.getElementById('btnStyle').classList.toggle('active',m==='style');
  document.getElementById('usageSearch').placeholder=m==='fabric'?'Type a fabric number...':'Type a style...';
  renderUsageList();
}
function renderUsageList(){
  const q = document.getElementById('usageSearch').value.toUpperCase().trim();

  // Build counts from filteredRows so year/week selection is reflected
  const filteredMap = {};
  filteredRows.forEach(r => {
    const key = usageMode === 'fabric' ? r.fabricNorm : r.style;
    if (key) filteredMap[key] = (filteredMap[key] || 0) + 1;
  });

  let entries = Object.entries(filteredMap)
    .filter(([k]) => !q || k.toUpperCase().includes(q))
    .sort((a, b) => b[1] - a[1]);

  const max  = entries[0]?.[1] || 1;
  const list = document.getElementById('usageList');
  if (!entries.length) { list.innerHTML = `<div class="no-results">No results${q ? ` for "${esc(q)}"` : ' in current filter'}</div>`; return; }

  list.innerHTML = entries.map(([name, count], i) => {
    const bw     = Math.round(count / max * 90);
    const poRaw  = usageMode === 'fabric' ? (latestPOMap[name]?.po || '') : '';
    const po     = poRaw.replace(/^po[:\s]+/i, '').trim();
    const poHtml = po ? `<span style="font-size:10px;color:var(--teal);font-family:'JetBrains Mono',monospace;margin-left:4px;">PO: ${esc(po)}</span>` : '';
    return `<div class="usage-row" style="animation-delay:${i*.04}s"">
      <span class="usage-rank">${i+1}</span>
      <div style="flex:1;min-width:0;"><div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;"><span class="usage-name">${esc(name)}</span>${poHtml}</div></div>
      <div class="usage-bar-wrap"><div class="usage-bar" style="width:${bw}px;max-width:90px;"></div><span class="usage-count">${count}Ã—</span></div>
    </div>`;
  }).join('');
}

// â”€â”€ TOP 10 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTop10(){
  const sM={},fM={};
  filteredRows.forEach(r=>{
    if(r.style)      sM[r.style]      =(sM[r.style]     ||0)+1;
    if(r.fabricNorm) fM[r.fabricNorm] =(fM[r.fabricNorm]||0)+1;
  });
  const t10s=Object.entries(sM).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const t10f=Object.entries(fM).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const mxS=t10s[0]?.[1]||1, mxF=t10f[0]?.[1]||1;
  const rl=i=>i===0?'â‘ ':i===1?'â‘¡':i===2?'â‘¢':`${i+1}`;
  const rc=i=>i===0?'r1':i===1?'r2':i===2?'r3':'';
  const mk=(arr,mx)=>arr.length?arr.map(([n,c],i)=>`
    <div class="top10-row">
      <div class="top10-num ${rc(i)}">${rl(i)}</div>
      <div class="top10-info"><div class="top10-name" title="${esc(n)}">${esc(n)}</div><div class="top10-bar" style="width:${Math.round(c/mx*100)}%"></div></div>
      <div class="top10-count">${c}Ã—</div>
    </div>`).join(''):'<div class="empty-msg">No data.</div>';
  document.getElementById('top10Styles').innerHTML=mk(t10s,mxS);
  document.getElementById('top10Fabrics').innerHTML=mk(t10f,mxF);
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts(){
  const sM={},fM={};
  filteredRows.forEach(r=>{
    if(r.style)      sM[r.style]      =(sM[r.style]     ||0)+1;
    if(r.fabricNorm) fM[r.fabricNorm] =(fM[r.fabricNorm]||0)+1;
  });
  makeBar('chartStyles',  Object.entries(sM).sort((a,b)=>b[1]-a[1]).slice(0,14),'#4d8bf5','Uses');
  makeBar('chartFabrics', Object.entries(fM).sort((a,b)=>b[1]-a[1]).slice(0,14),'#20d4ee','Uses');

  const weeks=[ ...new Set(filteredRows.map(r=>r.sheet))].sort();
  const top5=Object.entries(fM).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k])=>k);
  const colors=['#68c7c1','#f37d59','#faca78','#dd5341','#764838'];
  destroyChart('chartTrend');
  if(weeks.length>1&&top5.length){
    charts.chartTrend=new Chart(document.getElementById('chartTrend').getContext('2d'),{
      type:'line',
      data:{labels:weeks,datasets:top5.map((fab,i)=>({
        label:fab, data:weeks.map(w=>filteredRows.filter(r=>r.fabricNorm===fab&&r.sheet===w).length),
        borderColor:colors[i],backgroundColor:colors[i]+'18',fill:true,tension:0.35,pointRadius:3,borderWidth:2
      }))},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'top',labels:{color:'#7a9ec0',font:{family:'Space Grotesk',size:11},padding:12,boxWidth:10}}},
        scales:{
          x:{grid:{color:'rgba(100,160,255,.05)'},ticks:{color:'#3d5470',font:{size:10},maxRotation:35,maxTicksLimit:12}},
          y:{grid:{color:'rgba(100,160,255,.05)'},ticks:{color:'#3d5470',font:{size:10},stepSize:1}}
        }}
    });
  } else {
    const el=document.getElementById('chartTrend');
    if(el) el.parentElement.innerHTML='<div class="empty-msg">Not enough weeks to show a trend.</div>';
  }
}
function makeBar(id,data,color,yLabel){
  destroyChart(id);
  charts[id]=new Chart(document.getElementById(id).getContext('2d'),{
    type:'bar',
    data:{labels:data.map(([k])=>k),datasets:[{data:data.map(([,v])=>v),
      backgroundColor:data.map((_,i)=>color+Math.max(160,190-i*3).toString(16).padStart(2,'0')),
      borderRadius:5,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.raw}Ã—`}}},
      scales:{
        x:{grid:{color:'rgba(100,160,255,.05)'},ticks:{color:'#3d5470',font:{size:10},maxRotation:40,maxTicksLimit:14}},
        y:{grid:{color:'rgba(100,160,255,.05)'},ticks:{color:'#3d5470',font:{size:10},stepSize:1},title:{display:true,text:yLabel,color:'#3d5470',font:{size:10}}}
      }}
  });
}
function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id];}}

// â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(){
  const total=filteredRows.length,pages=Math.ceil(total/PAGE_SIZE),start=(page-1)*PAGE_SIZE;
  const slice=filteredRows.slice(start,start+PAGE_SIZE);
  document.getElementById('tableCount').textContent=`${total.toLocaleString()} items`;
  document.getElementById('tableBody').innerHTML=slice.length
    ?slice.map(r=>`<tr>
        <td><span class="sheet-tag">${esc(r.sheet)}</span></td>
        <td>${esc(r.vendor)||'â€”'}</td>
        <td><strong>${esc(r.style)}</strong></td>
        <td>${esc(r.fabricNorm)||'â€”'}</td>
        <td>${esc(r.supplier_fab)||'â€”'}</td>
        <td>${r.quantity?r.quantity.toLocaleString():'â€”'}</td>
        <td>${r.yield||'â€”'}</td>
        <td>${r.yardage?r.yardage.toLocaleString():'â€”'}</td>
        <td>${r.stock?r.stock.toLocaleString():'0'}</td>
        <td><span class="count-pill count-fab">${r.fabricUses}Ã—</span></td>
        <td><span class="count-pill count-style">${r.styleUses}Ã—</span></td>
        <td><span class="po-tag">${esc(r.latestPO)||'â€”'}</span></td>
        <td>${badge(r.status)}</td>
      </tr>`).join('')
    :`<tr><td colspan="13"><div class="empty-msg">No items match your filters.</div></td></tr>`;
  document.getElementById('pageInfo').textContent=`${Math.min(start+1,total).toLocaleString()}â€“${Math.min(start+PAGE_SIZE,total).toLocaleString()} of ${total.toLocaleString()}`;
  let btns=`<button class="page-btn" onclick="goPage(${page-1})" ${page<=1?'disabled':''}>â€¹</button>`;
  for(let p=1;p<=Math.min(pages,7);p++) btns+=`<button class="page-btn ${p===page?'active':''}" onclick="goPage(${p})">${p}</button>`;
  btns+=`<button class="page-btn" onclick="goPage(${page+1})" ${page>=pages?'disabled':''}>â€º</button>`;
  document.getElementById('pageBtns').innerHTML=btns;
}

function toggleTable(){
  const el=document.getElementById('tableCollapsible');
  const chev=document.getElementById('tableChevron');
  const hint=document.getElementById('tableToggleHint');
  const open=el.style.display==='none';
  el.style.display=open?'block':'none';
  chev.style.transform=open?'rotate(180deg)':'rotate(0deg)';
  hint.textContent=open?'Click to collapse':'Click to expand';
}

function goPage(p){const max=Math.ceil(filteredRows.length/PAGE_SIZE);if(p<1||p>max)return;page=p;renderTable();}
function badge(s){
  if(!s)return`<span style="color:var(--muted)">â€”</span>`;
  if(s==='ok')return`<span class="badge badge-ok">âœ“ OK</span>`;
  if(s.startsWith('buy'))return`<span class="badge badge-buy">â†‘ ${esc(s.toUpperCase())}</span>`;
  return`<span style="color:var(--muted)">${esc(s)}</span>`;
}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function setStatus(state,text){
  document.getElementById('dot').className='dot '+(state==='live'?'':state);
  document.getElementById('statusText').textContent=text;
}

loadData();
setInterval(loadData,REFRESH_MS);
</script>
</body>
</html>
